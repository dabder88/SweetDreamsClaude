# üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PsyDream (Supabase PostgreSQL)

> **–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç —Ñ–∞–π–ª —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î.
> **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
> **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —á–∏—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º –ª—é–±–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞.

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è](#–æ–±—â–∞—è-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
2. [–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ-—Ç–∞–±–ª–∏—Ü—ã)
3. [–°–∏—Å—Ç–µ–º–∞ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤](#—Å–∏—Å—Ç–µ–º–∞-ai-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
4. [–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å-–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
5. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞ –±—É–¥—É—â–µ–µ)](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-—Ç–∞–±–ª–∏—Ü—ã-–Ω–∞-–±—É–¥—É—â–µ–µ)
6. [–§—É–Ω–∫—Ü–∏–∏ –∏ —Ö—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã](#—Ñ—É–Ω–∫—Ü–∏–∏-–∏-—Ö—Ä–∞–Ω–∏–º—ã–µ-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã)
7. [–ò–Ω–¥–µ–∫—Å—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–∏–Ω–¥–µ–∫—Å—ã-–∏-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
8. [Row Level Security (RLS)](#row-level-security-rls)
9. [–ú–∏–≥—Ä–∞—Ü–∏–∏](#–º–∏–≥—Ä–∞—Ü–∏–∏)

---

## üåê –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ü—Ä–æ–µ–∫—Ç:** PsyDream - –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π
**–°–£–ë–î:** PostgreSQL —á–µ—Ä–µ–∑ Supabase
**–ö–æ–¥–∏—Ä–æ–≤–∫–∞:** UTF-8
**–°—Ö–µ–º–∞:** `public`
**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** Supabase Auth (—Ç–∞–±–ª–∏—Ü–∞ `auth.users`)

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
- ‚úÖ **Row Level Security (RLS)** –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ **JSONB** –¥–ª—è –≥–∏–±–∫–∏—Ö –ø–æ–ª–µ–π (metadata, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- ‚úÖ **UUID** –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∫–ª—é—á–µ–π
- ‚úÖ **Timestamps** –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö (`created_at`, `updated_at`)
- ‚úÖ **Foreign Keys** —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º–∏ —É–¥–∞–ª–µ–Ω–∏—è–º–∏ –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
- ‚úÖ **–ò–Ω–¥–µ–∫—Å—ã** –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—è—Ö

---

## üìä –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

### 1. `dream_entries` - –ñ—É—Ä–Ω–∞–ª —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π

–•—Ä–∞–Ω–∏—Ç –∑–∞–ø–∏—Å–∏ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞.

```sql
CREATE TABLE dream_entries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  timestamp BIGINT NOT NULL,              -- Unix timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  dream_data JSONB NOT NULL,              -- –û–ø–∏—Å–∞–Ω–∏–µ —Å–Ω–∞ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
  analysis JSONB,                         -- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã AI-–∞–Ω–∞–ª–∏–∑–∞
  image_url TEXT,                         -- URL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  notes TEXT,                             -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `dream_data` (JSONB):**
```json
{
  "description": "–¢–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Å–Ω–∞",
  "context": {
    "emotion": "—Ä–∞–¥–æ—Å—Ç—å | —Å—Ç—Ä–∞—Ö | —Ç—Ä–µ–≤–æ–≥–∞ | ...",
    "lifeSituation": "–æ–ø–∏—Å–∞–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏",
    "associations": "–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏",
    "recurring": true/false,
    "dayResidue": "—Å–æ–±—ã—Ç–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è",
    "characterTypes": "—Ç–∏–ø—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π",
    "dreamRole": "—Ä–æ–ª—å —Å–Ω–æ–≤–∏–¥—Ü–∞",
    "physicalSensations": "—Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –æ—â—É—â–µ–Ω–∏—è"
  },
  "method": "jungian | freudian | gestalt | cognitive | existential | auto"
}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `analysis` (JSONB):**
```json
{
  "summary": "–∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ",
  "mainAnalysis": "–æ—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑",
  "advice": "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
  "questions": ["–≤–æ–ø—Ä–æ—Å 1", "–≤–æ–ø—Ä–æ—Å 2"],
  "symbols": [
    {
      "name": "–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞",
      "meaning": "–∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞"
    }
  ]
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_dream_entries_user_id` - –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `idx_dream_entries_timestamp DESC` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

**RLS –ø–æ–ª–∏—Ç–∏–∫–∏:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏ (`auth.uid() = user_id`)
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –∑–∞–ø–∏—Å–∏

---

### 2. `analysis_metadata` - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∞–Ω–∞–ª–∏–∑–æ–≤

–•—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∞–Ω–∞–ª–∏–∑–µ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ).

```sql
CREATE TABLE analysis_metadata (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  dream_description TEXT,                 -- –û–ø–∏—Å–∞–Ω–∏–µ —Å–Ω–∞ (–¥–ª—è –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤)
  analysis_method TEXT,                   -- –ú–µ—Ç–æ–¥ –∞–Ω–∞–ª–∏–∑–∞
  timestamp BIGINT NOT NULL,              -- Unix timestamp
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ (–¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∂—É—Ä–Ω–∞–ª)
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É

**RLS:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `dream_entries`

---

### 3. `admin_users` - –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

–•—Ä–∞–Ω–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

```sql
CREATE TABLE admin_users (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `UNIQUE(user_id)` - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω admin record
- –ü–µ—Ä–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL
- –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é `demote_admin_to_user`)

**RLS:**
- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤
- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SECURITY DEFINER —Ñ—É–Ω–∫—Ü–∏–∏

---

### 4. `audit_log` - –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

–•—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π.

```sql
CREATE TABLE audit_log (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  admin_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  action_type TEXT NOT NULL,              -- 'USER_ROLE_CHANGED', 'DREAM_DELETED', –∏ —Ç.–¥.
  target_user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  details JSONB,                          -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –¥–µ–π—Å—Ç–≤–∏–∏
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π (`action_type`):**
- `USER_ROLE_CHANGED` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (admin ‚Üî user)
- `DREAM_DELETED` - —É–¥–∞–ª–µ–Ω–∏–µ —Å–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- `SETTINGS_CHANGED` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `details` (JSONB):**
```json
{
  "from": "user",
  "to": "admin",
  "target_email": "user@example.com",
  "reason": "–ø—Ä–∏—á–∏–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_audit_log_admin_id` - –ø–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
- `idx_audit_log_target_user_id` - –ø–æ —Ü–µ–ª–µ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `idx_audit_log_created_at DESC` - –ø–æ –¥–∞—Ç–µ
- `idx_audit_log_action_type` - –ø–æ —Ç–∏–ø—É –¥–µ–π—Å—Ç–≤–∏—è

**RLS:**
- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –ª–æ–≥–∏
- –ó–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SECURITY DEFINER —Ñ—É–Ω–∫—Ü–∏–∏

---

## ü§ñ –°–∏—Å—Ç–µ–º–∞ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### 5. `ai_provider_configs` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

–•—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (Gemini, OpenAI, Claude, AiTunnel, NeuroAPI).

```sql
CREATE TABLE ai_provider_configs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  provider_type TEXT NOT NULL CHECK (provider_type IN ('gemini', 'openai', 'claude', 'aitunnel', 'neuroapi', 'custom')) UNIQUE,
  provider_name TEXT NOT NULL,            -- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

  -- –§–ª–∞–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ —Ç–∏–ø—É –∑–∞–¥–∞—á–∏
  is_active_for_text BOOLEAN DEFAULT false,     -- –ê–Ω–∞–ª–∏–∑ —Å–Ω–æ–≤
  is_active_for_images BOOLEAN DEFAULT false,   -- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

  -- –ú–æ–¥–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
  default_model_id_for_text UUID REFERENCES ai_models(id) ON DELETE SET NULL,
  default_model_id_for_images UUID REFERENCES ai_models(id) ON DELETE SET NULL,

  -- API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
  api_key_env_name TEXT,                  -- –ò–º—è env –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä 'VITE_API_KEY')
  base_url TEXT,                          -- –ë–∞–∑–æ–≤—ã–π URL API
  config JSONB DEFAULT '{}',              -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

  -- Legacy –ø–æ–ª—è (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  is_active BOOLEAN DEFAULT false,
  default_model_id UUID REFERENCES ai_models(id) ON DELETE SET NULL,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `config` (JSONB):**
```json
{
  "temperature": 0.4,
  "max_tokens": 8192,
  "top_p": 1.0
}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- `UNIQUE(provider_type)` - –æ–¥–∏–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞
- –¢–æ–ª—å–∫–æ **–û–î–ò–ù** –ø—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω –¥–ª—è —Ç–µ–∫—Å—Ç–∞ (`is_active_for_text = true`)
- –¢–æ–ª—å–∫–æ **–û–î–ò–ù** –ø—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (`is_active_for_images = true`)

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_ai_provider_configs_active` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `idx_one_active_text_provider` - UNIQUE partial index (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞)
- `idx_one_active_image_provider` - UNIQUE partial index (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–¥–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)

**RLS:**
- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∏–∑–º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å (–¥–ª—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –≤ UI)

---

### 6. `ai_models` - –ö–∞—Ç–∞–ª–æ–≥ AI –º–æ–¥–µ–ª–µ–π

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

```sql
CREATE TABLE ai_models (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  provider_type TEXT NOT NULL,            -- –¢–∏–ø –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
  model_id TEXT NOT NULL,                 -- ID –º–æ–¥–µ–ª–∏ –¥–ª—è API (–Ω–∞–ø—Ä–∏–º–µ—Ä 'gpt-5-mini')
  model_name TEXT NOT NULL,               -- –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
  provider_name TEXT,                     -- –ò–º—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (OpenAI, Anthropic, Google)

  -- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
  capabilities JSONB DEFAULT '{"text": true, "image": false, "reasoning": false}',

  -- –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
  pricing JSONB DEFAULT '{"input": 0, "output": 0, "currency": "USD", "per": "1M tokens"}',

  -- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  performance JSONB DEFAULT '{"intelligence": "medium", "speed": "medium"}',

  -- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
  model_config JSONB DEFAULT '{"temperature": 0.4, "max_tokens": 8192, "top_p": 1.0}',

  -- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
  context_length INTEGER DEFAULT 128000,  -- –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö
  is_available BOOLEAN DEFAULT true,      -- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(provider_type, model_id)
);
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `capabilities` (JSONB):**
```json
{
  "text": true,         // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
  "image": true,        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  "reasoning": true     // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π
}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `pricing` (JSONB):**
```json
{
  "input": 4.5,         // –¶–µ–Ω–∞ –∑–∞ –≤—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
  "output": 360,        // –¶–µ–Ω–∞ –∑–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
  "currency": "RUB",    // –í–∞–ª—é—Ç–∞ (RUB, USD)
  "per": "1M tokens"    // –ó–∞ –∫–∞–∫–æ–π –æ–±—ä–µ–º
}
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `performance` (JSONB):**
```json
{
  "intelligence": "highest | high | medium | low",
  "speed": "fastest | fast | medium | slow"
}
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_ai_models_provider_type` - –ø–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
- `idx_ai_models_available` - —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏

**RLS:**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `ai_provider_configs`

**–í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:**
- ‚ö†Ô∏è **`"image": true`** –≤ `capabilities` –æ–∑–Ω–∞—á–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ù–ï –∞–Ω–∞–ª–∏–∑!
- ‚ö†Ô∏è –í—Å–µ –º–æ–¥–µ–ª–∏ GPT/Claude/Gemini –º–æ–≥—É—Ç *–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å* –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (multimodal), –Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ (DALL-E, Imagen, Flux, Stable Diffusion)

---

## üõ°Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –°–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π

**–î–≤–µ —Ä–æ–ª–∏:**
1. **User** (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ `auth.users` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
2. **Admin** (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ `admin_users`

**–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:**
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–æ–≤—ã—à–µ–Ω–∏–µ/–ø–æ–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏
- ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä audit –ª–æ–≥–æ–≤
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–¥–µ–ª—É "AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã" –≤ –º–µ–Ω—é

**–ó–∞—â–∏—Ç–∞:**
- –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `audit_log`
- RLS –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

---

### Privacy Settings (–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å)

**–ü–æ–ª–µ:** `raw_user_meta_data` –≤ —Ç–∞–±–ª–∏—Ü–µ `auth.users` (JSONB)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```json
{
  "privacy_hide_dreams": true/false
}
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ï—Å–ª–∏ `privacy_hide_dreams = true`, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ù–ï –≤–∏–¥—è—Ç:
  - ‚ùå –°–ø–∏—Å–æ–∫ —Å–Ω–æ–≤–∏–¥–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - ‚ùå –ê–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ —Å–Ω–∞–º
  - ‚úÖ –ù–æ –≤–∏–¥—è—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–Ω–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üîÆ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞ –±—É–¥—É—â–µ–µ)

> **–°–¢–ê–¢–£–°:** –≠—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Supabase Dashboard –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.
> **–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è** –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
> **–ù–ï –∏–º–µ—é—Ç** SQL-–º–∏–≥—Ä–∞—Ü–∏–π –≤ `supabase/migrations/`.

### 7. `user_balances` - –ë–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –±—É–¥—É—â–µ–π –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏).

```sql
CREATE TABLE user_balances (
  user_id UUID REFERENCES auth.users(id) PRIMARY KEY,
  balance NUMERIC DEFAULT 0,
  currency TEXT DEFAULT 'USD',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã AI-–∑–∞–ø—Ä–æ—Å–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –≤–∞–ª—é—Ç (USD, RUB, —Ç–æ–∫–µ–Ω—ã)
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `transactions`

---

### 8. `user_subscriptions` - –ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.

```sql
CREATE TABLE user_subscriptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  plan_id UUID REFERENCES subscription_plans(id),
  status TEXT CHECK (status IN ('active', 'expired', 'cancelled')),
  started_at TIMESTAMP WITH TIME ZONE,
  expires_at TIMESTAMP WITH TIME ZONE,
  auto_renew BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–ü–æ–ª—è:**
- `status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ (active/expired/cancelled)
- `plan_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏
- `auto_renew` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ

**–°–≤—è–∑—å:** `plan_id` ‚Üí `subscription_plans.id`

---

### 9. `subscription_plans` - –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫ (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.

```sql
CREATE TABLE subscription_plans (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  price NUMERIC NOT NULL,
  currency TEXT DEFAULT 'USD',
  duration_days INTEGER NOT NULL,
  features JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `features` (JSONB):**
```json
{
  "max_dreams_per_month": 100,
  "image_generation": true,
  "priority_support": true,
  "advanced_analytics": true
}
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∞—Ä–∏—Ñ–∞—Ö (Basic, Pro, Premium)
- –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π —á–µ—Ä–µ–∑ JSONB
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –≤–∞–ª—é—Ç –∏ —Å—Ä–æ–∫–æ–≤ –¥–µ–π—Å—Ç–≤–∏—è

---

### 10. `transactions` - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

```sql
CREATE TABLE transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  type TEXT CHECK (type IN ('credit', 'debit', 'refund')),
  amount NUMERIC NOT NULL,
  balance_before NUMERIC,
  balance_after NUMERIC,
  status TEXT CHECK (status IN ('pending', 'completed', 'failed')),
  description TEXT,
  admin_id UUID REFERENCES auth.users(id),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
- `credit` - –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- `debit` - —Å–ø–∏—Å–∞–Ω–∏–µ (–∑–∞ AI-–∑–∞–ø—Ä–æ—Å—ã)
- `refund` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

**–ü–æ–ª—è:**
- `balance_before/after` - —Å–Ω–∏–º–æ–∫ –±–∞–ª–∞–Ω—Å–∞ –¥–æ/–ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `admin_id` - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä, –≤—ã–ø–æ–ª–Ω–∏–≤—à–∏–π –æ–ø–µ—Ä–∞—Ü–∏—é (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- `metadata` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (ID –∑–∞–ø—Ä–æ—Å–∞, —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ç.–¥.)

---

### 11. `usage_metrics` - –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.

```sql
CREATE TABLE usage_metrics (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  action_type TEXT NOT NULL,           -- 'dream_analysis', 'image_generation', 'archetype_analysis'
  provider_used TEXT,                  -- 'gemini', 'openai', 'claude', –∏ —Ç.–¥.
  model_used TEXT,                     -- 'gpt-5-mini', 'claude-sonnet-4-5', –∏ —Ç.–¥.
  tokens_used INTEGER,                 -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
  response_time_ms INTEGER,            -- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  success BOOLEAN DEFAULT true,        -- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
  error_message TEXT,                  -- –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ success = false)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π
- –ü–æ–¥—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**–ò–Ω–¥–µ–∫—Å—ã (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–µ):**
- `idx_usage_metrics_user_id` - –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- `idx_usage_metrics_created_at` - –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `idx_usage_metrics_provider` - –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º

---

### 12. `system_settings` - –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

```sql
CREATE TABLE system_settings (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_by UUID REFERENCES auth.users(id)
);
```

**–ü—Ä–∏–º–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```json
{
  "key": "maintenance_mode",
  "value": {"enabled": false, "message": "Maintenance in progress"}
}
```

```json
{
  "key": "default_ai_provider",
  "value": {"provider": "gemini", "model": "gemini-2.5-flash"}
}
```

```json
{
  "key": "rate_limits",
  "value": {
    "free_tier": {"requests_per_day": 10},
    "pro_tier": {"requests_per_day": 100}
  }
}
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Feature flags
- –õ–∏–º–∏—Ç—ã –∏ –∫–≤–æ—Ç—ã
- –†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

---

## üîß –§—É–Ω–∫—Ü–∏–∏ –∏ —Ö—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

### 1. `promote_user_to_admin(target_user_id UUID)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–≤—ã—à–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –í—ã–∑—ã–≤–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- ‚úÖ –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "success": true/false,
  "message": "...",
  "error": "..." // –µ—Å–ª–∏ success = false
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```sql
SELECT promote_user_to_admin('user-uuid-here');
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `audit_log` —Å `action_type = 'USER_ROLE_CHANGED'`

---

### 2. `demote_admin_to_user(target_user_id UUID)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–Ω–∏–∂–∞–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –í—ã–∑—ã–≤–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- ‚úÖ –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- ‚úÖ **–ö–†–ò–¢–ò–ß–ù–û:** –≠—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ —Å–∏—Å—Ç–µ–º–µ

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ `promote_user_to_admin`

**–ó–∞—â–∏—Ç–∞ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–¥–º–∏–Ω–∞:**
```sql
IF admin_count <= 1 THEN
  RETURN jsonb_build_object(
    'success', false,
    'error', 'Cannot remove the last admin. System must have at least one administrator.'
  );
END IF;
```

---

### 3. `get_all_users()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–¥–º–∏–Ω-—Å—Ç–∞—Ç—É—Å–µ.

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** `SECURITY DEFINER` - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```sql
TABLE (
  id UUID,
  email VARCHAR(255),
  created_at TIMESTAMPTZ,
  raw_user_meta_data JSONB,       -- –í–∫–ª—é—á–∞–µ—Ç privacy_hide_dreams
  last_sign_in_at TIMESTAMPTZ,
  email_confirmed_at TIMESTAMPTZ,
  is_admin BOOLEAN                -- TRUE –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ admin_users
)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞:**
```sql
IF NOT EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid()) THEN
  RAISE EXCEPTION 'Access denied: admin role required';
END IF;
```

---

## ‚ö° –ò–Ω–¥–µ–∫—Å—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ò–Ω–¥–µ–∫—Å—ã –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º

**`dream_entries`:**
- `idx_dream_entries_user_id` - –ø–æ–∏—Å–∫ —Å–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_dream_entries_timestamp DESC` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ

**`audit_log`:**
- `idx_audit_log_admin_id` - –ª–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
- `idx_audit_log_target_user_id` - –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `idx_audit_log_created_at DESC` - —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è
- `idx_audit_log_action_type` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –¥–µ–π—Å—Ç–≤–∏—è

**`ai_provider_configs`:**
- `idx_ai_provider_configs_active WHERE is_active = true` - –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä

**`ai_models`:**
- `idx_ai_models_provider_type` - –º–æ–¥–µ–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `idx_ai_models_available WHERE is_available = true` - –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏

---

## üîí Row Level Security (RLS)

### –ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ü—Ä–∏–Ω—Ü–∏–ø:** –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏–º–µ—é—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.

### `dream_entries`

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–Ω—ã
CREATE POLICY "Users can view own dreams"
  ON dream_entries FOR SELECT
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ —Å–Ω—ã
CREATE POLICY "Users can insert own dreams"
  ON dream_entries FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–≤–æ–∏ —Å–Ω—ã
CREATE POLICY "Users can update own dreams"
  ON dream_entries FOR UPDATE
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å —Å–≤–æ–∏ —Å–Ω—ã
CREATE POLICY "Users can delete own dreams"
  ON dream_entries FOR DELETE
  USING (auth.uid() = user_id);
```

### `audit_log`

```sql
-- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –ª–æ–≥–∏
CREATE POLICY "Admins can view all audit logs"
  ON audit_log FOR SELECT
  USING (EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid()));

-- –ó–∞–ø–∏—Å—å –ª–æ–≥–æ–≤ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ SECURITY DEFINER —Ñ—É–Ω–∫—Ü–∏–∏
CREATE POLICY "System can insert audit logs"
  ON audit_log FOR INSERT
  WITH CHECK (true);
```

### `ai_provider_configs` –∏ `ai_models`

```sql
-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å
CREATE POLICY "Admins can manage provider configs"
  ON ai_provider_configs FOR ALL
  USING (EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid()));
```

---

## üìú –ú–∏–≥—Ä–∞—Ü–∏–∏

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

1. ‚úÖ `admin_role_management.sql` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ä–æ–ª–µ–π –∏ audit_log
2. ‚úÖ `add_privacy_hide_dreams.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ privacy –Ω–∞—Å—Ç—Ä–æ–µ–∫
3. ‚úÖ `merge_audit_logs.sql` - –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
4. ‚úÖ `20250129_create_ai_providers.sql` - —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
5. ‚úÖ `20250129_add_model_config.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–¥–µ–ª–µ–π
6. ‚úÖ `20250129_split_ai_tasks.sql` - —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á (text/image)
7. ‚úÖ `20250129_seed_ai_providers.sql` - –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
8. ‚úÖ `20250129_fix_image_capabilities.sql` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ image capability
9. ‚úÖ `20250129_seed_image_models.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
10. ‚úÖ `20250129_remove_neuroapi_dalle3.sql` - —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
11. ‚úÖ `20250130_update_aitunnel_models.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π AiTunnel
12. ‚úÖ `20250131_update_neuroapi_models.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π NeuroAPI (68 —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π)
13. ‚úÖ `20250131_fix_text_models_image_capability.sql` - **–ö–†–ò–¢–ò–ß–ù–û:** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ capabilities.image –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏—è–º

- ‚ö†Ô∏è –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã** (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ)
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç `CREATE TABLE IF NOT EXISTS`, `DROP POLICY IF EXISTS`, –∏ —Ç.–¥.
- ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—è—é—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç `ON CONFLICT DO NOTHING/UPDATE` –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö

---

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î

### –ü–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º SQL-–∑–∞–ø—Ä–æ—Å–∞:

1. ‚úÖ **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –ø—Ä–æ—á–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü
3. ‚úÖ –£—á–∏—Ç—ã–≤–∞–π RLS –ø–æ–ª–∏—Ç–∏–∫–∏
4. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (UUID, JSONB, timestamps)
5. ‚úÖ –î–æ–±–∞–≤–ª—è–π –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∏–¥–µ—Ç –ø–æ–∏—Å–∫

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

1. ‚úÖ –°–¥–µ–ª–∞–π –º–∏–≥—Ä–∞—Ü–∏—é **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π**
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
3. ‚úÖ –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ–ª—è–º –∏ —Ç–∞–±–ª–∏—Ü–∞–º
4. ‚úÖ –°–æ–∑–¥–∞–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
5. ‚úÖ –û–±–Ω–æ–≤–∏ —ç—Ç–æ—Ç —Ñ–∞–π–ª `DATABASE_STRUCTURE.md`

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã:

1. ‚úÖ **–í–°–ï–ì–î–ê** –æ–±–Ω–æ–≤–ª—è–π `DATABASE_STRUCTURE.md`
2. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π –ø—Ä–∏—á–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
4. ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π –º–∏–≥—Ä–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

---

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–≤—è–∑–µ–π —Ç–∞–±–ª–∏—Ü

```
auth.users (Supabase Auth)
    ‚Üì
    ‚îú‚îÄ‚Üí dream_entries (user_id FK)
    ‚îÇ   ‚îî‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å—ã: user_id, timestamp DESC
    ‚îÇ
    ‚îú‚îÄ‚Üí analysis_metadata (user_id FK)
    ‚îÇ   ‚îî‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å—ã: user_id, timestamp
    ‚îÇ
    ‚îú‚îÄ‚Üí admin_users (user_id FK, UNIQUE)
    ‚îÇ   ‚îî‚îÄ‚îÄ RLS: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç
    ‚îÇ
    ‚îî‚îÄ‚Üí audit_log (admin_id FK, target_user_id FK)
        ‚îî‚îÄ‚îÄ RLS: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç

ai_provider_configs
    ‚îú‚îÄ‚îÄ default_model_id_for_text ‚Üí ai_models.id (FK)
    ‚îú‚îÄ‚îÄ default_model_id_for_images ‚Üí ai_models.id (FK)
    ‚îî‚îÄ‚îÄ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
        ‚îú‚îÄ‚îÄ UNIQUE(provider_type)
        ‚îú‚îÄ‚îÄ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω is_active_for_text = true
        ‚îî‚îÄ‚îÄ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω is_active_for_images = true

ai_models
    ‚îú‚îÄ‚îÄ –ö–ª—é—á: (provider_type, model_id) UNIQUE
    ‚îî‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å—ã: provider_type, is_available
```

---

## üîÑ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–∞

| –î–∞—Ç–∞       | –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------------|--------|-----------|
| 2025-01-31 | 1.1    | –î–æ–±–∞–≤–ª–µ–Ω—ã 6 —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü (–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ REST API) |
| 2025-01-31 | 1.0    | –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ |

---

## üö® –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –í –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–µ–≤–µ—Ä–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–ï—Å–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ **AI –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã** ‚Üí **"–ò–ò –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"** –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ (GPT-5, Claude, –∏ —Ç.–¥.) –≤–º–µ—Å—Ç–æ –º–æ–¥–µ–ª–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (DALL-E, Imagen, Flux), —Å–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:

üìÑ **[FIX_IMAGE_MODELS.md](./FIX_IMAGE_MODELS.md)** - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

**–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor
UPDATE ai_models
SET capabilities = jsonb_set(capabilities, '{image}', 'false'::jsonb)
WHERE capabilities->>'text' = 'true'
  AND capabilities->>'image' = 'true';
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-31
**–ê–≤—Ç–æ—Ä:** Claude (AI Assistant)
**–ü—Ä–æ–µ–∫—Ç:** PsyDream - AI-powered Dream Analysis Platform
