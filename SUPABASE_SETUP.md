# Supabase Setup Guide для PsyDream

Это пошаговая инструкция по настройке Supabase для включения многопользовательского режима и облачного хранения снов.

## Зачем нужен Supabase?

- ✅ **Регистрация и вход пользователей** - каждый пользователь получает свой защищенный аккаунт
- ✅ **Облачное хранение** - сны сохраняются в базе данных, а не в браузере
- ✅ **Доступ с любого устройства** - войдите с любого компьютера и получите доступ к своим снам
- ✅ **Защита данных** - Row Level Security гарантирует, что пользователи видят только свои записи
- ✅ **Автоматическая миграция** - существующие сны из localStorage автоматически переносятся в облако при первом входе

## Шаг 1: Создание проекта Supabase

1. Перейдите на [supabase.com](https://supabase.com)
2. Нажмите **"Start your project"** и зарегистрируйтесь (можно через GitHub)
3. Нажмите **"New Project"**
4. Заполните форму:
   - **Name**: `psydream` (или любое другое название)
   - **Database Password**: придумайте надежный пароль и сохраните его
   - **Region**: выберите ближайший регион (например, `Europe (Frankfurt)`)
5. Нажмите **"Create new project"**
6. Подождите 1-2 минуты пока проект создается

## Шаг 2: Получение API ключей

1. В боковом меню выберите **Settings** (⚙️ внизу слева)
2. Перейдите в **API**
3. Скопируйте два значения:
   - **Project URL** (например: `https://abcdefghijklm.supabase.co`)
   - **anon public** ключ (длинная строка, начинается с `eyJ...`)

## Шаг 3: Настройка переменных окружения

1. Откройте файл `.env` в корне проекта (или создайте его)
2. Добавьте/обновите следующие строки:

```env
# Gemini API Key (уже должен быть)
VITE_API_KEY=your_gemini_api_key_here

# Supabase Configuration (новые)
VITE_SUPABASE_URL=https://abcdefghijklm.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**ВАЖНО:** Замените значения на свои, скопированные на Шаге 2!

## Шаг 4: Создание базы данных

1. В Supabase dashboard откройте **SQL Editor** (левое меню)
2. Нажмите **"+ New query"**
3. Скопируйте содержимое файла [`supabase-schema.sql`](supabase-schema.sql) и вставьте в редактор
4. Нажмите **"Run"** (или Ctrl+Enter)
5. Вы должны увидеть сообщение "Success. No rows returned"

Это создаст:
- Таблицу `dream_entries` для хранения снов
- Политики безопасности (RLS), чтобы пользователи видели только свои данные
- Индексы для быстрого поиска

## Шаг 5: Настройка аутентификации

### Email провайдер (основной способ входа)

1. Откройте **Authentication** → **Providers**
2. Email провайдер уже включен по умолчанию ✅

### Отключение подтверждения email (для разработки)

Если не хотите настраивать SMTP и проверять email при каждой регистрации:

1. Откройте **Authentication** → **Settings**
2. Найдите раздел **User Signups**
3. **Отключите** "Enable email confirmations"
4. Нажмите **Save**

⚠️ **Для продакшена** рекомендуется оставить email подтверждение включенным!

### OAuth провайдеры (опционально)

Для входа через Google/GitHub:

1. **Authentication** → **Providers**
2. Включите нужного провайдера (Google, GitHub и т.д.)
3. Следуйте инструкциям для получения Client ID и Client Secret
4. Сохраните настройки

## Шаг 6: Тестирование

1. Убедитесь, что `.env` файл заполнен правильными значениями
2. Запустите приложение:
   ```bash
   npm install  # если еще не установлены зависимости
   npm run dev
   ```
3. Откройте [http://localhost:5173](http://localhost:5173)
4. Нажмите **"Личный кабинет"** или попробуйте войти в Dashboard
5. Вас перенаправит на страницу входа
6. Нажмите **"Нет аккаунта? Зарегистрируйтесь"**
7. Заполните форму регистрации
8. Если email подтверждение включено - проверьте почту (и спам!)
9. Войдите в систему
10. Создайте тестовый сон и проверьте, что он сохраняется

## Шаг 7: Проверка данных в Supabase

1. Откройте **Table Editor** в Supabase dashboard
2. Выберите таблицу `dream_entries`
3. Вы должны увидеть свои сохраненные сны с полями:
   - `id` - UUID записи
   - `user_id` - ID пользователя
   - `timestamp` - время создания
   - `dream_data` - описание сна и контекст (JSON)
   - `analysis` - результат анализа (JSON)
   - `image_url` - ссылка на изображение (если было создано)
   - `notes` - ваши заметки

## Миграция существующих данных

Если у вас уже есть сны в localStorage (из предыдущего использования приложения):

1. Войдите в систему под новым аккаунтом
2. Приложение автоматически найдет локальные сны
3. Все сны будут загружены в облако
4. Локальные данные останутся как резервная копия

✨ **Готово!** Теперь ваше приложение работает с облачной базой данных и поддерживает регистрацию пользователей!

## Troubleshooting

### Ошибка: "Invalid API key"
- Проверьте, что в `.env` переменные начинаются с `VITE_`
- Перезапустите dev сервер после изменения `.env`

### Ошибка: "Row Level Security policy violation"
- Убедитесь, что вы выполнили SQL из `supabase-schema.sql`
- Проверьте, что RLS политики созданы в **Authentication** → **Policies**

### Email подтверждение не приходит
- Проверьте папку "Спам"
- Отключите email подтверждение в настройках (см. Шаг 5)
- Настройте собственный SMTP в **Settings** → **Auth** → **SMTP Settings**

### Данные не сохраняются
- Откройте консоль браузера (F12) и проверьте ошибки
- Убедитесь, что вы вошли в систему (проверьте имя пользователя в Sidebar)
- Проверьте, что Supabase проект активен (не в режиме паузы)

## Дополнительные настройки

### Кастомизация email шаблонов

1. **Authentication** → **Email Templates**
2. Выберите шаблон (Confirm signup, Reset password и т.д.)
3. Отредактируйте HTML и текст письма
4. Сохраните изменения

### Настройка SMTP (собственный email сервер)

1. **Settings** → **Auth** → **SMTP Settings**
2. Включите "Enable Custom SMTP"
3. Введите данные вашего SMTP сервера
4. Сохраните и протестируйте отправку

### Мониторинг пользователей

1. **Authentication** → **Users**
2. Здесь вы увидите всех зарегистрированных пользователей
3. Можете удалять/блокировать пользователей при необходимости

## Безопасность

- ✅ **Anon ключ безопасно** использовать на клиенте - он ограничен Row Level Security
- ✅ **Пользователи изолированы** - RLS политики гарантируют, что каждый видит только свои данные
- ⚠️ **Никогда не публикуйте** `service_role` ключ (он дает полный доступ к БД)

## Полезные ссылки

- [Supabase Documentation](https://supabase.com/docs)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Supabase Auth](https://supabase.com/docs/guides/auth)
